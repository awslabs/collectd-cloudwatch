from cloudwatch.modules.logger.logger import get_logger

_DATASET_MAP = {
    'absolute': [['value', 'ABSOLUTE']],
    'apache_bytes': [['value', 'DERIVE']],
    'apache_connections': [['value', 'GAUGE']],
    'apache_idle_workers': [['value', 'GAUGE']],
    'apache_requests': [['value', 'DERIVE']],
    'apache_scoreboard': [['value', 'GAUGE']],
    'arc_counts': [['demand_data', 'COUNTER'],
                   ['demand_metadata', 'COUNTER'],
                   ['prefetch_data', 'COUNTER'],
                   ['prefetch_metadata', 'COUNTER']],
    'arc_l2_bytes': [['read', 'COUNTER'], ['write', 'COUNTER']],
    'arc_l2_size': [['value', 'GAUGE']],
    'arc_ratio': [['value', 'GAUGE']],
    'arc_size': [['current', 'GAUGE'],
                 ['target', 'GAUGE'],
                 ['minlimit', 'GAUGE'],
                 ['maxlimit', 'GAUGE']],
    'ath_nodes': [['value', 'GAUGE']],
    'ath_stat': [['value', 'DERIVE']],
    'backends': [['value', 'GAUGE']],
    'bitrate': [['value', 'GAUGE']],
    'blocked_clients': [['value', 'GAUGE']],
    'bytes': [['value', 'GAUGE']],
    'cache_eviction': [['value', 'DERIVE']],
    'cache_operation': [['value', 'DERIVE']],
    'cache_ratio': [['value', 'GAUGE']],
    'cache_result': [['value', 'DERIVE']],
    'cache_size': [['value', 'GAUGE']],
    'ceph_bytes': [['value', 'GAUGE']],
    'ceph_latency': [['value', 'GAUGE']],
    'ceph_rate': [['value', 'DERIVE']],
    'changes_since_last_save': [['value', 'GAUGE']],
    'charge': [['value', 'GAUGE']],
    'compression': [['uncompressed', 'DERIVE'], ['compressed', 'DERIVE']],
    'compression_ratio': [['value', 'GAUGE']],
    'connections': [['value', 'DERIVE']],
    'conntrack': [['value', 'GAUGE']],
    'contextswitch': [['value', 'DERIVE']],
    'count': [['value', 'GAUGE']],
    'counter': [['value', 'COUNTER']],
    'cpu': [['value', 'DERIVE']],
    'cpufreq': [['value', 'GAUGE']],
    'current': [['value', 'GAUGE']],
    'current_connections': [['value', 'GAUGE']],
    'current_sessions': [['value', 'GAUGE']],
    'delay': [['value', 'GAUGE']],
    'derive': [['value', 'DERIVE']],
    'df': [['used', 'GAUGE'], ['free', 'GAUGE']],
    'df_complex': [['value', 'GAUGE']],
    'df_inodes': [['value', 'GAUGE']],
    'disk_io_time': [['io_time', 'DERIVE'], ['weighted_io_time', 'DERIVE']],
    'disk_latency': [['read', 'GAUGE'], ['write', 'GAUGE']],
    'disk_merged': [['read', 'DERIVE'], ['write', 'DERIVE']],
    'disk_octets': [['read', 'DERIVE'], ['write', 'DERIVE']],
    'disk_ops': [['read', 'DERIVE'], ['write', 'DERIVE']],
    'disk_ops_complex': [['value', 'DERIVE']],
    'disk_time': [['read', 'DERIVE'], ['write', 'DERIVE']],
    'dns_answer': [['value', 'DERIVE']],
    'dns_notify': [['value', 'DERIVE']],
    'dns_octets': [['queries', 'DERIVE'], ['responses', 'DERIVE']],
    'dns_opcode': [['value', 'DERIVE']],
    'dns_qtype': [['value', 'DERIVE']],
    'dns_qtype_cached': [['value', 'GAUGE']],
    'dns_query': [['value', 'DERIVE']],
    'dns_question': [['value', 'DERIVE']],
    'dns_rcode': [['value', 'DERIVE']],
    'dns_reject': [['value', 'DERIVE']],
    'dns_request': [['value', 'DERIVE']],
    'dns_resolver': [['value', 'DERIVE']],
    'dns_response': [['value', 'DERIVE']],
    'dns_transfer': [['value', 'DERIVE']],
    'dns_update': [['value', 'DERIVE']],
    'dns_zops': [['value', 'DERIVE']],
    'drbd_resource': [['value', 'DERIVE']],
    'duration': [['seconds', 'GAUGE']],
    'email_check': [['value', 'GAUGE']],
    'email_count': [['value', 'GAUGE']],
    'email_size': [['value', 'GAUGE']],
    'entropy': [['value', 'GAUGE']],
    'expired_keys': [['value', 'GAUGE']],
    'fanspeed': [['value', 'GAUGE']],
    'file_handles': [['value', 'GAUGE']],
    'file_size': [['value', 'GAUGE']],
    'files': [['value', 'GAUGE']],
    'flow': [['value', 'GAUGE']],
    'fork_rate': [['value', 'DERIVE']],
    'frequency': [['value', 'GAUGE']],
    'frequency_offset': [['value', 'GAUGE']],
    'fscache_stat': [['value', 'DERIVE']],
    'gauge': [['value', 'GAUGE']],
    'hash_collisions': [['value', 'DERIVE']],
    'http_request_methods': [['value', 'DERIVE']],
    'http_requests': [['value', 'DERIVE']],
    'http_response_codes': [['value', 'DERIVE']],
    'humidity': [['value', 'GAUGE']],
    'if_collisions': [['value', 'DERIVE']],
    'if_dropped': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'if_errors': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'if_multicast': [['value', 'DERIVE']],
    'if_octets': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'if_packets': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'if_rx_errors': [['value', 'DERIVE']],
    'if_rx_octets': [['value', 'DERIVE']],
    'if_tx_errors': [['value', 'DERIVE']],
    'if_tx_octets': [['value', 'DERIVE']],
    'invocations': [['value', 'DERIVE']],
    'io_octets': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'io_packets': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'ipt_bytes': [['value', 'DERIVE']],
    'ipt_packets': [['value', 'DERIVE']],
    'irq': [['value', 'DERIVE']],
    'latency': [['value', 'GAUGE']],
    'links': [['value', 'GAUGE']],
    'load': [['shortterm', 'GAUGE'], ['midterm', 'GAUGE'], ['longterm', 'GAUGE']],
    'md_disks': [['value', 'GAUGE']],
    'memcached_command': [['value', 'DERIVE']],
    'memcached_connections': [['value', 'GAUGE']],
    'memcached_items': [['value', 'GAUGE']],
    'memcached_octets': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'memcached_ops': [['value', 'DERIVE']],
    'memory': [['value', 'GAUGE']],
    'memory_lua': [['value', 'GAUGE']],
    'multimeter': [['value', 'GAUGE']],
    'mutex_operations': [['value', 'DERIVE']],
    'mysql_bpool_bytes': [['value', 'GAUGE']],
    'mysql_bpool_counters': [['value', 'DERIVE']],
    'mysql_bpool_pages': [['value', 'GAUGE']],
    'mysql_commands': [['value', 'DERIVE']],
    'mysql_handler': [['value', 'DERIVE']],
    'mysql_innodb_data': [['value', 'DERIVE']],
    'mysql_innodb_dblwr': [['value', 'DERIVE']],
    'mysql_innodb_log': [['value', 'DERIVE']],
    'mysql_innodb_pages': [['value', 'DERIVE']],
    'mysql_innodb_row_lock': [['value', 'DERIVE']],
    'mysql_innodb_rows': [['value', 'DERIVE']],
    'mysql_locks': [['value', 'DERIVE']],
    'mysql_log_position': [['value', 'DERIVE']],
    'mysql_octets': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'mysql_qcache': [['hits', 'COUNTER'],
                     ['inserts', 'COUNTER'],
                     ['not_cached', 'COUNTER'],
                     ['lowmem_prunes', 'COUNTER'],
                     ['queries_in_cache', 'GAUGE']],
    'mysql_select': [['value', 'DERIVE']],
    'mysql_sort': [['value', 'DERIVE']],
    'mysql_threads': [['running', 'GAUGE'],
                      ['connected', 'GAUGE'],
                      ['cached', 'GAUGE'],
                      ['created', 'COUNTER']],
    'nfs_procedure': [['value', 'DERIVE']],
    'nginx_connections': [['value', 'GAUGE']],
    'nginx_requests': [['value', 'DERIVE']],
    'node_octets': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'node_rssi': [['value', 'GAUGE']],
    'node_stat': [['value', 'DERIVE']],
    'node_tx_rate': [['value', 'GAUGE']],
    'objects': [['value', 'GAUGE']],
    'operations': [['value', 'DERIVE']],
    'packets': [['value', 'DERIVE']],
    'pending_operations': [['value', 'GAUGE']],
    'percent': [['value', 'GAUGE']],
    'percent_bytes': [['value', 'GAUGE']],
    'percent_inodes': [['value', 'GAUGE']],
    'pf_counters': [['value', 'DERIVE']],
    'pf_limits': [['value', 'DERIVE']],
    'pf_source': [['value', 'DERIVE']],
    'pf_state': [['value', 'DERIVE']],
    'pf_states': [['value', 'GAUGE']],
    'pg_blks': [['value', 'DERIVE']],
    'pg_db_size': [['value', 'GAUGE']],
    'pg_n_tup_c': [['value', 'DERIVE']],
    'pg_n_tup_g': [['value', 'GAUGE']],
    'pg_numbackends': [['value', 'GAUGE']],
    'pg_scan': [['value', 'DERIVE']],
    'pg_xact': [['value', 'DERIVE']],
    'ping': [['value', 'GAUGE']],
    'ping_droprate': [['value', 'GAUGE']],
    'ping_stddev': [['value', 'GAUGE']],
    'players': [['value', 'GAUGE']],
    'power': [['value', 'GAUGE']],
    'pressure': [['value', 'GAUGE']],
    'protocol_counter': [['value', 'DERIVE']],
    'ps_code': [['value', 'GAUGE']],
    'ps_count': [['processes', 'GAUGE'], ['threads', 'GAUGE']],
    'ps_cputime': [['user', 'DERIVE'], ['syst', 'DERIVE']],
    'ps_data': [['value', 'GAUGE']],
    'ps_disk_octets': [['read', 'DERIVE'], ['write', 'DERIVE']],
    'ps_disk_ops': [['read', 'DERIVE'], ['write', 'DERIVE']],
    'ps_pagefaults': [['minflt', 'DERIVE'], ['majflt', 'DERIVE']],
    'ps_rss': [['value', 'GAUGE']],
    'ps_stacksize': [['value', 'GAUGE']],
    'ps_state': [['value', 'GAUGE']],
    'ps_vm': [['value', 'GAUGE']],
    'pubsub': [['value', 'GAUGE']],
    'queue_length': [['value', 'GAUGE']],
    'records': [['value', 'GAUGE']],
    'requests': [['value', 'GAUGE']],
    'response_code': [['value', 'GAUGE']],
    'response_time': [['value', 'GAUGE']],
    'route_etx': [['value', 'GAUGE']],
    'route_metric': [['value', 'GAUGE']],
    'routes': [['value', 'GAUGE']],
    'segments': [['value', 'GAUGE']],
    'serial_octets': [['rx', 'DERIVE'], ['tx', 'DERIVE']],
    'signal_noise': [['value', 'GAUGE']],
    'signal_power': [['value', 'GAUGE']],
    'signal_quality': [['value', 'GAUGE']],
    'smart_attribute': [['current', 'GAUGE'],
                        ['worst', 'GAUGE'],
                        ['threshold', 'GAUGE'],
                        ['pretty', 'GAUGE']],
    'smart_badsectors': [['value', 'GAUGE']],
    'smart_powercycles': [['value', 'GAUGE']],
    'smart_poweron': [['value', 'GAUGE']],
    'smart_temperature': [['value', 'GAUGE']],
    'snr': [['value', 'GAUGE']],
    'spam_check': [['value', 'GAUGE']],
    'spam_score': [['value', 'GAUGE']],
    'spl': [['value', 'GAUGE']],
    'swap': [['value', 'GAUGE']],
    'swap_io': [['value', 'DERIVE']],
    'tcp_connections': [['value', 'GAUGE']],
    'temperature': [['value', 'GAUGE']],
    'threads': [['value', 'GAUGE']],
    'time_dispersion': [['value', 'GAUGE']],
    'time_offset': [['value', 'GAUGE']],
    'timeleft': [['value', 'GAUGE']],
    'total_bytes': [['value', 'DERIVE']],
    'total_connections': [['value', 'DERIVE']],
    'total_objects': [['value', 'DERIVE']],
    'total_operations': [['value', 'DERIVE']],
    'total_requests': [['value', 'DERIVE']],
    'total_sessions': [['value', 'DERIVE']],
    'total_threads': [['value', 'DERIVE']],
    'total_time_in_ms': [['value', 'DERIVE']],
    'total_values': [['value', 'DERIVE']],
    'uptime': [['value', 'GAUGE']],
    'users': [['value', 'GAUGE']],
    'vcl': [['value', 'GAUGE']],
    'vcpu': [['value', 'GAUGE']],
    'virt_cpu_total': [['value', 'DERIVE']],
    'virt_vcpu': [['value', 'DERIVE']],
    'vmpage_action': [['value', 'DERIVE']],
    'vmpage_faults': [['minflt', 'DERIVE'], ['majflt', 'DERIVE']],
    'vmpage_io': [['in', 'DERIVE'], ['out', 'DERIVE']],
    'vmpage_number': [['value', 'GAUGE']],
    'volatile_changes': [['value', 'GAUGE']],
    'voltage': [['value', 'GAUGE']],
    'voltage_threshold': [['value', 'GAUGE'], ['threshold', 'GAUGE']],
    'vs_memory': [['value', 'GAUGE']],
    'vs_processes': [['value', 'GAUGE']],
    'vs_threads': [['value', 'GAUGE']]}


class CollectdDatasetResolver:
    def __init__(self, get_dataset):
        self._get_dataset = get_dataset

    def get_dataset_names(self, dataset_type):
        dataset = self._get_dataset(dataset_type)
        if dataset:
            return [ds[0] for ds in dataset]

        return None

    def get_dataset_types(self, dataset_type):
        dataset = self._get_dataset(dataset_type)
        if dataset:
            return [ds[1] for ds in dataset]

        return None


def _static_get_dataset(dataset_type):
    return _DATASET_MAP.get(dataset_type)


def get_dataset_resolver():
    try:
        from collectd import get_dataset

        return CollectdDatasetResolver(get_dataset=get_dataset)
    except ImportError as e:
        get_logger(__name__).warning('collectd.get_dataset() not found, using static dataset configuration, some multivalue metrics might have incorrect names.')

        return CollectdDatasetResolver(get_dataset=_static_get_dataset)
